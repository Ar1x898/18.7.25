<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Locked Gallery</title>
  <meta name="description" content="Two-stage lock: preliminary gate, then gallery unlock." />
  <style>
    :root{
      --bg:#0b0f14; --surface:#121821; --card:#0e141c; --edge:#1e293b;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#5eead4; --accent-2:#60a5fa;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35); --maxw:1200px;
      --pink1:#fbcfe8; --pink2:#f9a8d4; --pink3:#f472b6;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg) center/cover no-repeat fixed;
      color:#5c3d4c; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .hidden{display:none!important}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(to right,var(--pink1),var(--pink2));border-bottom:1px solid var(--pink3)}
    .bar{max-width:var(--maxw);margin:0 auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{font-weight:700;letter-spacing:.2px;display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 9px var(--accent)}
    .btn{background:var(--pink3);color:#fff;border:none;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn:hover{background:#ec4899}
    .toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .input{background:#ffe4e1;border:1px solid #f9a8d4;border-radius:999px;padding:10px 12px;outline:none;color:#7a2941;min-width:220px}
    main{max-width:var(--maxw);margin:28px auto;padding:0 20px 40px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(8,1fr)}}
    @media (max-width:740px){.grid{grid-template-columns:repeat(4,1fr)}}
    .card{grid-column:span 4;background:linear-gradient(180deg,#fff0f5,#ffe4e1);border:1px solid #fbb6ce;border-radius:var(--radius);overflow:hidden;box-shadow:0 8px 20px rgba(255,192,203,.4);position:relative;transition:transform .2s,border-color .2s,box-shadow .2s;isolation:isolate}
    .card:hover{transform:scale(1.02);border-color:var(--pink3);box-shadow:0 12px 28px rgba(255,182,193,.6)}
    .card img{width:100%;height:220px;display:block;object-fit:cover;background:#0a0f16;user-select:none;-webkit-user-drag:none}
    .card .controls{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;background:#fff0f5;border-top:1px solid #fbcfe8}
    .label{font-size:14px;color:#933b4b;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .note-toggle{background:#f9a8d4;border:1px solid #f472b6;color:#fff;border-radius:10px;padding:8px 10px;font-weight:600;cursor:pointer}
    .note-toggle:hover{background:#f472b6}
    .note{position:absolute;inset:auto 10px 10px 10px;background:rgba(255,240,245,.95);border:1px solid #f9a8d4;border-radius:12px;padding:12px 14px;box-shadow:0 10px 30px rgba(0,0,0,.5);transform:translateY(6px);transition:opacity .18s,transform .18s;color:#5c3d4c}
    .note[hidden]{opacity:0;transform:translateY(12px);pointer-events:none}
    .note p{margin:0;line-height:1.45;color:#4b2e39}
    .note small{color:#7c4d60;display:block;margin-top:8px}

    /* Full-screen gate (preliminary) */
    .gate{position:fixed;inset:0;z-index:9999;display:grid;place-items:center;background:#000 url('binary.jpg') center/cover no-repeat;font-family:'Courier New',Courier,monospace;color:#00ffcc;text-shadow:0 0 5px #00ffcc;padding:20px}
    .panel{width:min(560px,92vw);background:rgba(0,0,0,.82);border:1px solid #00ffcc;border-radius:12px;box-shadow:0 0 20px #00ffccaa;padding:24px}
    .panel h1{margin:0 0 4px;font-size:20px;letter-spacing:.2px;color:#eafffb}
    .panel p.sub{margin:0 0 14px;color:#8bf0e0;font-size:14px}
    .field{display:flex;gap:10px;align-items:center;background:#071218;border:1px solid #0aaea0;border-radius:12px;padding:10px}
    .pw-wrap{position:relative;flex:1;display:flex;align-items:center}
    input[type="password"], input[type="text"].pw{
      flex:1;background:transparent;border:none;outline:none;color:#eafffb;font-size:16px;padding:6px 4px
    }
    .eye{position:absolute;right:6px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:#8bf0e0;cursor:pointer;font-weight:700}
    .unlock{white-space:nowrap;border:1px solid #0aaea0;background:linear-gradient(180deg,#0a2a2f,#091c20);color:#eafffb;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
    .unlock:hover{border-color:#29ffd3}
    .hint{font-size:12px;color:#f59e0b;margin-top:6px;min-height:1em}
    .msg{min-height:24px;margin-top:10px;color:#ffb3be;font-weight:700}
    @keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}
    .shake{animation:shake .35s both}
    noscript{display:block;max-width:740px;margin:40px auto;padding:16px;border:1px solid #b91c1c;border-radius:12px;background:#7f1d1d;color:#fee2e2;font-weight:600}

    /* Gallery veil (main) */
    .gallery-wrap{position:relative}
    .gallery-veil{
      position:absolute; inset:0; display:grid; place-items:center;
      background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.55));
      backdrop-filter:saturate(0.7) blur(2px);
      border-radius:12px; z-index:3; padding:18px;
    }
    .gallery-blurred{ filter: blur(10px) brightness(0.6); pointer-events:none; }
    .mini-panel{
      width:min(520px,92vw); background:rgba(15,23,42,.85); border:1px solid #60a5fa;
      border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.45); padding:18px; color:#e5e7eb;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .mini-panel h2{margin:0 0 6px;font-size:18px}
    .mini-panel .field{background:#0b1220;border:1px solid #2a3a52}
    .mini-panel .unlock{border:1px solid #3b82f6;background:linear-gradient(180deg,#102033,#0b1422)}

    /* Lightbox */
    .lightbox{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.85);z-index:9998}
    .lightbox.open{display:grid}
    .lb-img{max-width:90vw;max-height:80vh;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.6)}
    .lb-caption{margin-top:12px;color:#e5e7eb;text-align:center;max-width:80vw}
    .lb-actions{position:absolute;top:16px;right:16px;display:flex;gap:8px}
    .icon-btn{background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:8px 10px;cursor:pointer}
    .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:999px;padding:10px 16px;box-shadow:0 10px 30px rgba(0,0,0,.4);opacity:0;transition:opacity .18s,transform .18s;z-index:9999}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
  </style>
</head>
<body>

<noscript>
  This site needs JavaScript to run. Enable JS to enter your access codes and continue.
</noscript>

<!-- ===== STAGE 1: PRELIM GATE ===== -->
<div id="preGate" class="gate" aria-labelledby="preGateTitle">
  <div class="panel" id="preGatePanel">
    <h1 id="preGateTitle">Security Check</h1>
    <p class="sub">If this is for you then you should know the code! What's your name?</p>
    <form id="preForm" autocomplete="off" novalidate>
      <div class="field">
        <div class="pw-wrap">
          <input id="prePass" class="pw" type="password" inputmode="text" placeholder="Preliminary code" aria-label="Preliminary code" required />
          <button class="eye" type="button" data-target="prePass" aria-label="Show or hide password">üëÅ</button>
        </div>
        <button class="unlock" type="submit" id="preBtn">Enter</button>
      </div>
      <div id="preHint" class="hint" aria-live="polite"></div>
      <div id="preMsg" class="msg" role="alert" aria-live="polite"></div>
    </form>
  </div>
</div>

<!-- ===== MAIN PAGE ===== -->
<header class="hidden" id="appHeader">
  <div class="bar">
    <div class="title"><span class="dot" aria-hidden="true"></span> <span id="siteTitle">Locked Gallery</span></div>
    <div class="toolbar">
      <input id="filterInput" class="input" type="text" placeholder="Filter by label‚Ä¶" aria-label="Filter images by label" />
      <button class="btn" id="shuffleBtn" title="Shuffle">Shuffle</button>
      <button class="btn" id="openAllBtn" title="Open all notes">Open notes</button>
      <button class="btn" id="closeAllBtn" title="Close all notes">Close notes</button>
      <button class="btn" id="lockGalleryBtn" title="Lock gallery">Lock Gallery</button>
      <button class="btn" id="lockAllBtn" title="Lock everything">Lock All</button>
    </div>
  </div>
</header>

<main id="app" class="hidden" tabindex="-1">
  <section aria-label="Image notes gallery" class="gallery-wrap">
    <div id="gallery" class="grid gallery-blurred" role="list"></div>

    <!-- ===== GALLERY VEIL ===== -->
    <div id="galleryVeil" class="gallery-veil" aria-labelledby="galleryTitle">
      <div class="mini-panel" id="galleryPanel">
        <h2 id="galleryTitle">Unlock Memory Gallery</h2>
        <p class="sub">What's my name? Enter for the memories!</p>
        <form id="galleryForm" autocomplete="off" novalidate>
          <div class="field">
            <div class="pw-wrap">
              <input id="galleryPass" class="pw" type="password" inputmode="text" placeholder="Gallery code" aria-label="Gallery code" required />
              <button class="eye" type="button" data-target="galleryPass" aria-label="Show or hide password">üëÅ</button>
            </div>
            <button class="unlock" type="submit" id="galleryBtn">Unlock</button>
          </div>
          <div id="galleryHint" class="hint" aria-live="polite"></div>
          <div id="galleryMsg" class="msg" role="alert" aria-live="polite"></div>
        </form>
      </div>
    </div>
  </section>
</main>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Image viewer">
  <div class="lb-actions">
    <button class="icon-btn" id="lbPrev" aria-label="Previous">‚ü®</button>
    <button class="icon-btn" id="lbNext" aria-label="Next">‚ü©</button>
    <button class="icon-btn" id="lbClose" aria-label="Close">‚úï</button>
  </div>
  <img id="lbImg" class="lb-img" alt="" />
  <div id="lbCaption" class="lb-caption"></div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ================= CONFIG ================= */

const CONFIG = {
  siteTitle: "1 Month Anniversary",
  clickAnywhereToToggle: true,

  backgroundImage: "1month.jpg", 

  twoStep: false,  

  prelim: {
    password: "francesca",    
    rememberHours: 4,
    caseSensitive: false
  },
  gallery: {
    password: "steven",        
    rememberHours: 8,
    caseSensitive: false
  },

  images: [
    { src: "curlhair.jpg",   alt: "Curly hair",       label: "Favourite selfie",                 note: "One of the earlier pics you sent me. I adore the curls! :)" },
    { src: "theft.jpg",      alt: "Theft is a crime", label: "Mirror pic",                       note: "We were waiting for that Yakiniku Like ticket, got a free 100g Karubi set and made sure to get 300g rice. Always nice to eat together, and it's cute how you always wanna sit side by side instead of opposite each other haha." },
    { src: "plq.jpg",        alt: "Rooftop vibes",    label: "PLQ roof",                         note: "Don't we just love rooftops? They make for the best conversations and late night talks (aside from vc of course). I really appreciate how much effort you take into establishing open communication, no matter if the topic may seem slightly uncomfortable. I hope to be able to return your favourite 3 word phrase soon. ;) " },
    { src: "toothless1.jpg", alt: "Specimen 1",       label: "Toothless hat",                    note: "Few hours before the fireworks. Wonder what happened that day? I'm sure the fireworks were memorable for both of us and some other things..." },
    { src: "toothless2.jpg", alt: "Specimen 2",       label: "Toothless",                        note: "You fit here better than me! I'll get you something related to Toothless soon, psst." },
    { src: "reservoir.jpg",  alt: "Lady of the lake", label: "Yishun Lake",                      note: "Waiting to cross the road, 2 views in 1. Look how good at pool you've become, might as well be better than me now." },
    { src: "stadium.jpg",    alt: "Stadium",          label: "Khatib Stadium",                   note: "Take more pics, though try a small grin. Better than a large smile anyday... " },
    { src: "bowling.jpg",    alt: "Bowling",          label: "First Bowling",                    note: "Still a commune if my memory serves me right, but doesn't 'commune' sound like such an elegant word though? Chose a nice frame, looks like you got a strike right? This marks the beginning of your withcraftery." },
    { src: "tictactoe.jpg",  alt: "TicTacToe",        label: "Early morning entertainment",      note: "Now this is what you call unforgettable, congrats on putting that forehead to good use! Does remind me of our late night to early morning poker runs..." },
    { src: "icebucket.jpg",  alt: "Ice Bucket",       label: "Ice bucket challenge",             note: "The umbrella was a good joke. So was my unfortunate Hitler hairdo. Wasn't this not long after Ori? Could you have envisioned this after orientation?" },
    { src: "hairbun.jpg",    alt: "Hair",             label: "Hair bun",                         note: "Whatever it takes to get those curls. Respect. Actually purple isn't such a bad colour either." },
    { src: "specs.jpg",      alt: "Specs",            label: "Wearing my specs",                 note: "Do you look like me with my specs? I don't get what's so horrible about your specs, but it definetely does not deserve so much fuss. If you do go looking for new specs, let me know so you can get a good pair. When is it time to transition from a minion?" },
    { src: "nex.jpg",        alt: "Nex",              label: "Nex Rooftop",                      note: "Now this was the prime rooftop, though if PLQ wasn't so far it would make for a better rooftop. Lots of things were said here, and I hope that we can continue to have such a thing. I know I'm not the most talkative person and I really like how you're able to somewhat read me. To truly understand a person is the best gift and hopefully we work to that." },
    { src: "chaoshair.jpg",  alt: "Pic",              label: "Chaotic hair",                     note: "These kinds of moments are funny, though it makes the finished product a lot more appreciated. How many times have I said I liked wavy hair?" },
    { src: "jacket.jpg",     alt: "Jacket",           label: "Jacket",                           note: "You still have my jacket till this day, but I have your sweater in exchange. It's good on you, especially when we played pool, I like to think it made you play better (schizophrenic delusions). Speaking of that, you really should have collected that bread for your sister..." },
  ]
};
</script>

<script>
/* =============== Utilities & Storage =============== */
const STORE_PRE  = "auth.prelim.v1";
const STORE_GAL  = "auth.gallery.v1";

const qs = new URLSearchParams(location.search);
/* Avoid calling URLSearchParams.has with undefined */
const DEV_BYPASS = (typeof CONFIG.devBypassParam === 'string') && qs.has(CONFIG.devBypassParam);

function now(){ return Date.now(); }

/* Storage with graceful fallback if localStorage is blocked */
const StorageBox = (() => {
  let mem = {};
  function canUseLS(){
    try{ localStorage.setItem("_t","1"); localStorage.removeItem("_t"); return true; }catch(_){ return false; }
  }
  const useLS = canUseLS();
  return {
    set(k,v){ if(useLS) localStorage.setItem(k,v); else mem[k]=v; },
    get(k){ return useLS ? localStorage.getItem(k) : mem[k] ?? null; },
    del(k){ if(useLS) localStorage.removeItem(k); else delete mem[k]; }
  };
})();

function remember(key, hours){
  try{
    const ttl = Math.max(1, Number(hours)||1);
    StorageBox.set(key, JSON.stringify({ exp: now() + ttl*3600*1000 }));
  }catch(_){}
}
function hasRemember(key){
  try{
    const raw = StorageBox.get(key);
    if(!raw) return false;
    const rec = JSON.parse(raw);
    if(!rec || typeof rec.exp!=='number') return false;
    if(now()>rec.exp){ StorageBox.del(key); return false; }
    return true;
  }catch(_){ return false; }
}
function clearRemember(key){ try{ StorageBox.del(key); }catch(_){ } }

/* Crypto helpers (optional SHA-256) */
async function sha256(str){
  const buf = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-256', buf);
  return [...new Uint8Array(hash)].map(x=>x.toString(16).padStart(2,'0')).join('');
}

function normalize(input, caseSensitive){
  return caseSensitive ? String(input||"") : String(input||"").toLowerCase();
}

/* =============== DOM refs =============== */
const preGate     = document.getElementById('preGate');
const prePanel    = document.getElementById('preGatePanel');
const preForm     = document.getElementById('preForm');
const prePass     = document.getElementById('prePass');
const preBtn      = document.getElementById('preBtn');
const preMsg      = document.getElementById('preMsg');
const preHint     = document.getElementById('preHint');

const appHeader   = document.getElementById('appHeader');
const app         = document.getElementById('app');
const siteTitleEl = document.getElementById('siteTitle');

const gallery     = document.getElementById('gallery');
const galleryVeil = document.getElementById('galleryVeil');
const galleryPanel= document.getElementById('galleryPanel');
const galleryForm = document.getElementById('galleryForm');
const galleryPass = document.getElementById('galleryPass');
const galleryBtn  = document.getElementById('galleryBtn');
const galleryMsg  = document.getElementById('galleryMsg');
const galleryHint = document.getElementById('galleryHint');

const lockGalleryBtn = document.getElementById('lockGalleryBtn');
const lockAllBtn     = document.getElementById('lockAllBtn');
const filterInput    = document.getElementById('filterInput');
const shuffleBtn     = document.getElementById('shuffleBtn');
const openAllBtn     = document.getElementById('openAllBtn');
const closeAllBtn    = document.getElementById('closeAllBtn');

const lightbox   = document.getElementById('lightbox');
const lbImg      = document.getElementById('lbImg');
const lbCaption  = document.getElementById('lbCaption');
const lbPrev     = document.getElementById('lbPrev');
const lbNext     = document.getElementById('lbNext');
const lbClose    = document.getElementById('lbClose');
const toastEl    = document.getElementById('toast');

/* =============== Helpers =============== */
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), 1500);
}
function setSiteTitle(){
  document.title = CONFIG.siteTitle || "Locked Gallery";
  if(siteTitleEl) siteTitleEl.textContent = CONFIG.siteTitle || "Locked Gallery";
}

/* Optional local background image */
(function setBackground(){
  if (CONFIG.backgroundImage){
    document.body.style.backgroundImage = `url('${CONFIG.backgroundImage}')`;
  }
})();

function showAppShell(){
  preGate.style.display = 'none';
  appHeader.classList.remove('hidden');
  app.classList.remove('hidden');
}
function showPreGate(){
  preGate.style.display = 'grid';
  appHeader.classList.add('hidden');
  app.classList.add('hidden');
  prePass.value = ''; preMsg.textContent = ''; preHint.textContent='';
  setTimeout(()=>prePass?.focus(), 0);
}
function unlockGalleryUI(){
  gallery.classList.remove('gallery-blurred');
  galleryVeil.classList.add('hidden');
}
function lockGalleryUI(){
  gallery.classList.add('gallery-blurred');
  galleryVeil.classList.remove('hidden');
  galleryPass.value = ''; galleryMsg.textContent = ''; galleryHint.textContent='';
  setTimeout(()=>galleryPass?.focus(), 0);
}

/* =============== Gallery builder =============== */
const PLACEHOLDER_SVG =
  'data:image/svg+xml;utf8,' + encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800">
      <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#1f2937"/><stop offset="100%" stop-color="#0b1020"/>
      </linearGradient></defs>
      <rect width="100%" height="100%" fill="url(#g)"/>
      <g fill="#93c5fd" font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" text-anchor="middle">
        <text x="50%" y="48%" font-size="36">Add your image at</text>
        <text x="50%" y="56%" font-size="28">CONFIG.images</text>
      </g>
    </svg>
  `);

function el(tag, attrs={}, ...children){
  const node = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if (v == null) continue;
    if (k === 'class') node.className = v;
    else if (k === 'style') Object.assign(node.style, v);
    else if (k.startsWith('on') && typeof v === 'function') node.addEventListener(k.slice(2), v);
    else if (k === 'html') node.innerHTML = v;
    else node.setAttribute(k, v);
  }
  for (const c of children){
    if (c == null) continue;
    node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
  }
  return node;
}

let galleryData = [];
function buildGallery(items){
  gallery.innerHTML = '';
  galleryData = (Array.isArray(items) && items.length ? items : [{
    src: PLACEHOLDER_SVG, alt: "Placeholder image", label: "Sample", note: "Edit CONFIG.images in the HTML to add your own images and notes."
  }]).map((it,i)=>({...it, _idx:i}));

  galleryData.forEach((it, i) => {
    const noteId = `note-${i}`;
    const img = el('img', { alt: it.alt || "", loading: 'lazy', decoding: 'async' });
    img.src = it.src || PLACEHOLDER_SVG;
    img.addEventListener('error', () => { img.src = PLACEHOLDER_SVG; });

    const btn = el('button', { class: 'note-toggle', 'aria-controls': noteId, 'aria-expanded': 'false', type: 'button' }, 'Show note');
    const label = el('div', { class: 'label', title: it.label || '' }, it.label || '');
    const controls = el('div', { class: 'controls' }, label, btn);
    const note = el('figcaption', { class: 'note', id: noteId, hidden: true }, el('p', {}, it.note || ''));

    const card = el('figure', { class: 'card', role: 'listitem', tabindex:"0" }, img, controls, note);

    function toggleNote(forceOpen){
      const willShow = (typeof forceOpen === 'boolean') ? forceOpen : note.hidden;
      note.hidden = !willShow;
      btn.setAttribute('aria-expanded', String(willShow));
      btn.textContent = willShow ? 'Hide note' : 'Show note';
    }
    btn.addEventListener('click', (ev)=>{ ev.stopPropagation(); toggleNote(); });

    img.style.cursor = 'pointer';
    card.addEventListener('click', (ev) => {
      if (ev.target === btn) return;
      toggleNote();
    });

    // Lightbox open on double-click or Enter
    function openLB(){ openLightbox(i); }
    img.addEventListener('dblclick', openLB);
    card.addEventListener('keydown', (e)=>{ if(e.key==='Enter') openLB(); });

    gallery.appendChild(card);
  });
}

/* Lightbox logic */
let lbIndex = 0;
function openLightbox(idx){
  lbIndex = (idx + galleryData.length) % galleryData.length;
  const it = galleryData[lbIndex] || {};
  lbImg.src = it.src || PLACEHOLDER_SVG;
  lbImg.alt = it.alt || '';
  lbCaption.innerHTML = `<strong>${it.label || ''}</strong><br>${it.note || ''}`;
  lightbox.classList.add('open');
}
function closeLightbox(){ lightbox.classList.remove('open'); }
function nextLB(){ openLightbox(lbIndex+1); }
function prevLB(){ openLightbox(lbIndex-1); }
lbClose.addEventListener('click', closeLightbox);
lbNext.addEventListener('click', nextLB);
lbPrev.addEventListener('click', prevLB);
lightbox.addEventListener('click', (e)=>{ if(e.target===lightbox) closeLightbox(); });
document.addEventListener('keydown', (e)=>{
  if(!lightbox.classList.contains('open')) return;
  if(e.key==='Escape') closeLightbox();
  if(e.key==='ArrowRight') nextLB();
  if(e.key==='ArrowLeft') prevLB();
});

/* =============== Init & Event handlers =============== */
(function init(){
  setSiteTitle();
  buildGallery(CONFIG.images);

  // Dev preview (skip both locks)
  if (DEV_BYPASS){
    showAppShell();
    unlockGalleryUI();
    toast('DEV bypass active');
    return;
  }

  // Stage 1 (preliminary gate)
  if (hasRemember(STORE_PRE)) {
    showAppShell();
  } else {
    showPreGate();
  }

  // Stage 2 (gallery veil)
  if (CONFIG.twoStep){
    if (hasRemember(STORE_GAL)) unlockGalleryUI();
    else lockGalleryUI();
  } else {
    // One-step mode always unlocks gallery
    unlockGalleryUI();
  }
})();

/* Caps Lock hints & show/hide buttons */
function wireCapsHint(inputEl, hintEl){
  inputEl.addEventListener('keyup', (e)=>{
    if (!('getModifierState' in e)) return;
    hintEl.textContent = e.getModifierState('CapsLock') ? 'Caps Lock is ON' : '';
  });
}
wireCapsHint(prePass, preHint);
wireCapsHint(galleryPass, galleryHint);

document.querySelectorAll('.eye').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id = btn.getAttribute('data-target');
    const el = document.getElementById(id);
    if(!el) return;
    if(el.type === 'password'){ el.type = 'text'; btn.textContent='üôà'; }
    else { el.type = 'password'; btn.textContent='üëÅ'; }
    el.focus();
  });
});

/* Crypto-based matcher
   NOTE: The original file had two matchesAsync() declarations.
   Keeping ONE resolves a Safari/Chrome strict duplicate binding error that stopped the login from running. */
async function matchesAsync(input, rules){
  const norm = rules.caseSensitive ? String(input||"") : String(input||"").toLowerCase();
  if (rules.passwordHash && rules.passwordHash.length === 64) {
    const hex = await sha256(norm);
    return hex === rules.passwordHash.toLowerCase();
  }
  return norm === (rules.caseSensitive ? String(rules.password||"") : String(rules.password||"").toLowerCase());
}

/* Gates (async) */
preForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const input = prePass.value.trim();
  if (!input){ preMsg.textContent='Please enter a code.'; return; }
  preBtn.disabled = true; preMsg.textContent = 'Checking‚Ä¶';
  try{
    const ok = await matchesAsync(input, CONFIG.prelim);
    if (ok){
      remember(STORE_PRE, CONFIG.prelim.rememberHours);
      showAppShell();
      toast('Preliminary gate unlocked');

      if (!CONFIG.twoStep){
        // Auto-unlock gallery in one-step mode (show "main page")
        remember(STORE_GAL, CONFIG.gallery.rememberHours);
        unlockGalleryUI();
      }
    } else {
      preMsg.textContent = 'Incorrect preliminary code.';
      prePanel.classList.remove('shake'); void prePanel.offsetWidth; prePanel.classList.add('shake');
    }
  } finally {
    preBtn.disabled = false;
  }
});

galleryForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!CONFIG.twoStep){ galleryMsg.textContent = 'Two-step is off.'; return; }
  const input = galleryPass.value.trim();
  if (!input){ galleryMsg.textContent='Please enter a code.'; return; }
  galleryBtn.disabled = true; galleryMsg.textContent = 'Checking‚Ä¶';
  try{
    const ok = await matchesAsync(input, CONFIG.gallery);
    if (ok){
      remember(STORE_GAL, CONFIG.gallery.rememberHours);
      unlockGalleryUI();
      toast('Gallery unlocked');
    } else {
      galleryMsg.textContent = 'Incorrect gallery code.';
      galleryPanel.classList.remove('shake'); void galleryPanel.offsetWidth; galleryPanel.classList.add('shake');
    }
  } finally {
    galleryBtn.disabled = false;
  }
});

/* Lock buttons */
lockGalleryBtn.addEventListener('click', ()=>{
  clearRemember(STORE_GAL);
  if (CONFIG.twoStep) lockGalleryUI(); else unlockGalleryUI(); // keep visible in one-step mode
  toast('Gallery lock cleared');
});
lockAllBtn.addEventListener('click', ()=>{
  clearRemember(STORE_GAL);
  clearRemember(STORE_PRE);
  if (CONFIG.twoStep) lockGalleryUI();
  showPreGate();
  toast('Everything locked');
});

/* Filter / Shuffle / Open-Close notes */
filterInput.addEventListener('input', ()=>{
  const q = filterInput.value.trim().toLowerCase();
  [...gallery.children].forEach((card, i)=>{
    const label = (galleryData[i]?.label || '').toLowerCase();
    card.style.display = (!q || label.includes(q)) ? '' : 'none';
  });
});
shuffleBtn.addEventListener('click', ()=>{
  for(let i=galleryData.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [galleryData[i], galleryData[j]] = [galleryData[j], galleryData[i]];
  }
  buildGallery(galleryData);
  filterInput.dispatchEvent(new Event('input'));
});
openAllBtn.addEventListener('click', ()=>{
  [...gallery.querySelectorAll('.note')].forEach(n=>n.hidden=false);
  [...gallery.querySelectorAll('.note-toggle')].forEach(b=>{ b.textContent='Hide note'; b.setAttribute('aria-expanded','true'); });
});
closeAllBtn.addEventListener('click', ()=>{
  [...gallery.querySelectorAll('.note')].forEach(n=>n.hidden=true);
  [...gallery.querySelectorAll('.note-toggle')].forEach(b=>{ b.textContent='Show note'; b.setAttribute('aria-expanded','false'); });
});

/* Quick keyboard focus */
window.addEventListener('keydown', (e)=>{
  if(e.key==='/' && document.activeElement.tagName!=='INPUT'){
    e.preventDefault(); filterInput.focus();
  }
});
</script>

</body>
</html>
